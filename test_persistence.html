<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据持久化测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .output { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; }
        .status { padding: 5px 10px; border-radius: 3px; margin: 5px 0; display: inline-block; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 数据持久化测试工具</h1>
        <p>这个工具用于测试服务器数据的保存和加载是否正常工作。</p>
        
        <div class="test-section">
            <h3>📊 当前服务器数据</h3>
            <button class="btn btn-primary" onclick="loadServerData()">加载服务器数据</button>
            <div id="server-data" class="output"></div>
        </div>
        
        <div class="test-section">
            <h3>✏️ 修改测试数据</h3>
            <button class="btn btn-success" onclick="addTestMember()">添加测试成员</button>
            <button class="btn btn-success" onclick="addTestTask()">添加测试任务</button>
            <button class="btn btn-warning" onclick="resetToDefault()">重置为默认数据</button>
            <div id="modify-status" class="output"></div>
        </div>
        
        <div class="test-section">
            <h3>🔄 刷新测试</h3>
            <p>点击下面的按钮来模拟页面刷新，检查数据是否持久保存：</p>
            <button class="btn btn-warning" onclick="simulateRefresh()">模拟页面刷新</button>
            <div id="refresh-status" class="output"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        
        async function loadServerData() {
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    currentData = await response.json();
                    document.getElementById('server-data').textContent = 
                        `✅ 成功加载服务器数据：\n` +
                        `成员数量: ${currentData.familyMembers.length}\n` +
                        `任务数量: ${currentData.familyTasks.length}\n` +
                        `最后更新: ${currentData.lastUpdated}\n\n` +
                        `详细数据:\n${JSON.stringify(currentData, null, 2)}`;
                } else {
                    document.getElementById('server-data').textContent = '❌ 加载失败: ' + response.statusText;
                }
            } catch (error) {
                document.getElementById('server-data').textContent = '❌ 网络错误: ' + error.message;
            }
        }
        
        async function addTestMember() {
            if (!currentData) {
                await loadServerData();
            }
            
            const testMember = {
                id: 'test_' + Date.now(),
                name: '测试成员_' + new Date().getSeconds()
            };
            
            currentData.familyMembers.push(testMember);
            await saveDataToServer('addTestMember');
        }
        
        async function addTestTask() {
            if (!currentData) {
                await loadServerData();
            }
            
            if (currentData.familyMembers.length === 0) {
                document.getElementById('modify-status').textContent = '❌ 请先添加成员';
                return;
            }
            
            const randomMember = currentData.familyMembers[Math.floor(Math.random() * currentData.familyMembers.length)];
            const testTask = {
                id: 'task_' + Date.now(),
                title: '测试任务_' + new Date().getSeconds(),
                assignee: randomMember.id,
                assigneeName: randomMember.name,
                priority: 'medium',
                status: 'todo',
                createdAt: new Date().toISOString()
            };
            
            currentData.familyTasks.push(testTask);
            await saveDataToServer('addTestTask');
        }
        
        async function resetToDefault() {
            currentData = {
                familyMembers: [
                    { id: 'mem001', name: '妈妈' },
                    { id: 'mem002', name: '爸爸' },
                    { id: 'mem003', name: '小明' },
                    { id: 'mem004', name: '小红' }
                ],
                familyTasks: [
                    { id: 'task001', title: '洗衣服', assignee: 'mem001', assigneeName: '妈妈', priority: 'medium', status: 'todo', createdAt: new Date().toISOString() },
                    { id: 'task002', title: '完成数学作业', assignee: 'mem003', assigneeName: '小明', priority: 'high', status: 'todo', createdAt: new Date().toISOString() },
                    { id: 'task003', title: '整理房间', assignee: 'mem004', assigneeName: '小红', priority: 'low', status: 'completed', createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), completedAt: new Date().toISOString() }
                ]
            };
            await saveDataToServer('resetToDefault');
        }
        
        async function saveDataToServer(operation) {
            try {
                const response = await fetch('/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('modify-status').textContent = 
                        `✅ ${operation} 成功\n` +
                        `时间戳: ${result.timestamp}\n` +
                        `当前成员: ${currentData.familyMembers.length}个\n` +
                        `当前任务: ${currentData.familyTasks.length}个`;
                } else {
                    document.getElementById('modify-status').textContent = '❌ 保存失败: ' + response.statusText;
                }
            } catch (error) {
                document.getElementById('modify-status').textContent = '❌ 保存错误: ' + error.message;
            }
        }
        
        async function simulateRefresh() {
            document.getElementById('refresh-status').textContent = '🔄 模拟页面刷新中...';
            
            // 保存刷新前的数据
            const beforeData = { ...currentData };
            currentData = null;
            
            // 等待一秒模拟页面刷新时间
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 重新加载数据
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    const afterData = await response.json();
                    
                    const membersBefore = beforeData ? beforeData.familyMembers.length : 0;
                    const tasksBefore = beforeData ? beforeData.familyTasks.length : 0;
                    const membersAfter = afterData.familyMembers.length;
                    const tasksAfter = afterData.familyTasks.length;
                    
                    const isPersistent = (membersBefore === membersAfter && tasksBefore === tasksAfter);
                    
                    document.getElementById('refresh-status').textContent = 
                        `${isPersistent ? '✅ 数据持久化成功!' : '❌ 数据持久化失败!'}\n\n` +
                        `刷新前: ${membersBefore}个成员, ${tasksBefore}个任务\n` +
                        `刷新后: ${membersAfter}个成员, ${tasksAfter}个任务\n\n` +
                        `最后更新时间: ${afterData.lastUpdated}`;
                    
                    currentData = afterData;
                } else {
                    document.getElementById('refresh-status').textContent = '❌ 刷新后加载失败: ' + response.statusText;
                }
            } catch (error) {
                document.getElementById('refresh-status').textContent = '❌ 刷新测试错误: ' + error.message;
            }
        }
        
        // 页面加载时自动加载数据
        window.onload = function() {
            loadServerData();
        };
    </script>
</body>
</html>