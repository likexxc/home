<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŒä¹…åŒ–æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .output { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; }
        .status { padding: 5px 10px; border-radius: 3px; margin: 5px 0; display: inline-block; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ•°æ®æŒä¹…åŒ–æµ‹è¯•å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·ç”¨äºæµ‹è¯•æœåŠ¡å™¨æ•°æ®çš„ä¿å­˜å’ŒåŠ è½½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        
        <div class="test-section">
            <h3>ğŸ“Š å½“å‰æœåŠ¡å™¨æ•°æ®</h3>
            <button class="btn btn-primary" onclick="loadServerData()">åŠ è½½æœåŠ¡å™¨æ•°æ®</button>
            <div id="server-data" class="output"></div>
        </div>
        
        <div class="test-section">
            <h3>âœï¸ ä¿®æ”¹æµ‹è¯•æ•°æ®</h3>
            <button class="btn btn-success" onclick="addTestMember()">æ·»åŠ æµ‹è¯•æˆå‘˜</button>
            <button class="btn btn-success" onclick="addTestTask()">æ·»åŠ æµ‹è¯•ä»»åŠ¡</button>
            <button class="btn btn-warning" onclick="resetToDefault()">é‡ç½®ä¸ºé»˜è®¤æ•°æ®</button>
            <div id="modify-status" class="output"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”„ åˆ·æ–°æµ‹è¯•</h3>
            <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ¥æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°ï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦æŒä¹…ä¿å­˜ï¼š</p>
            <button class="btn btn-warning" onclick="simulateRefresh()">æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°</button>
            <div id="refresh-status" class="output"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        
        async function loadServerData() {
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    currentData = await response.json();
                    document.getElementById('server-data').textContent = 
                        `âœ… æˆåŠŸåŠ è½½æœåŠ¡å™¨æ•°æ®ï¼š\n` +
                        `æˆå‘˜æ•°é‡: ${currentData.familyMembers.length}\n` +
                        `ä»»åŠ¡æ•°é‡: ${currentData.familyTasks.length}\n` +
                        `æœ€åæ›´æ–°: ${currentData.lastUpdated}\n\n` +
                        `è¯¦ç»†æ•°æ®:\n${JSON.stringify(currentData, null, 2)}`;
                } else {
                    document.getElementById('server-data').textContent = 'âŒ åŠ è½½å¤±è´¥: ' + response.statusText;
                }
            } catch (error) {
                document.getElementById('server-data').textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + error.message;
            }
        }
        
        async function addTestMember() {
            if (!currentData) {
                await loadServerData();
            }
            
            const testMember = {
                id: 'test_' + Date.now(),
                name: 'æµ‹è¯•æˆå‘˜_' + new Date().getSeconds()
            };
            
            currentData.familyMembers.push(testMember);
            await saveDataToServer('addTestMember');
        }
        
        async function addTestTask() {
            if (!currentData) {
                await loadServerData();
            }
            
            if (currentData.familyMembers.length === 0) {
                document.getElementById('modify-status').textContent = 'âŒ è¯·å…ˆæ·»åŠ æˆå‘˜';
                return;
            }
            
            const randomMember = currentData.familyMembers[Math.floor(Math.random() * currentData.familyMembers.length)];
            const testTask = {
                id: 'task_' + Date.now(),
                title: 'æµ‹è¯•ä»»åŠ¡_' + new Date().getSeconds(),
                assignee: randomMember.id,
                assigneeName: randomMember.name,
                priority: 'medium',
                status: 'todo',
                createdAt: new Date().toISOString()
            };
            
            currentData.familyTasks.push(testTask);
            await saveDataToServer('addTestTask');
        }
        
        async function resetToDefault() {
            currentData = {
                familyMembers: [
                    { id: 'mem001', name: 'å¦ˆå¦ˆ' },
                    { id: 'mem002', name: 'çˆ¸çˆ¸' },
                    { id: 'mem003', name: 'å°æ˜' },
                    { id: 'mem004', name: 'å°çº¢' }
                ],
                familyTasks: [
                    { id: 'task001', title: 'æ´—è¡£æœ', assignee: 'mem001', assigneeName: 'å¦ˆå¦ˆ', priority: 'medium', status: 'todo', createdAt: new Date().toISOString() },
                    { id: 'task002', title: 'å®Œæˆæ•°å­¦ä½œä¸š', assignee: 'mem003', assigneeName: 'å°æ˜', priority: 'high', status: 'todo', createdAt: new Date().toISOString() },
                    { id: 'task003', title: 'æ•´ç†æˆ¿é—´', assignee: 'mem004', assigneeName: 'å°çº¢', priority: 'low', status: 'completed', createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), completedAt: new Date().toISOString() }
                ]
            };
            await saveDataToServer('resetToDefault');
        }
        
        async function saveDataToServer(operation) {
            try {
                const response = await fetch('/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('modify-status').textContent = 
                        `âœ… ${operation} æˆåŠŸ\n` +
                        `æ—¶é—´æˆ³: ${result.timestamp}\n` +
                        `å½“å‰æˆå‘˜: ${currentData.familyMembers.length}ä¸ª\n` +
                        `å½“å‰ä»»åŠ¡: ${currentData.familyTasks.length}ä¸ª`;
                } else {
                    document.getElementById('modify-status').textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + response.statusText;
                }
            } catch (error) {
                document.getElementById('modify-status').textContent = 'âŒ ä¿å­˜é”™è¯¯: ' + error.message;
            }
        }
        
        async function simulateRefresh() {
            document.getElementById('refresh-status').textContent = 'ğŸ”„ æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°ä¸­...';
            
            // ä¿å­˜åˆ·æ–°å‰çš„æ•°æ®
            const beforeData = { ...currentData };
            currentData = null;
            
            // ç­‰å¾…ä¸€ç§’æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°æ—¶é—´
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // é‡æ–°åŠ è½½æ•°æ®
            try {
                const response = await fetch('/api/data');
                if (response.ok) {
                    const afterData = await response.json();
                    
                    const membersBefore = beforeData ? beforeData.familyMembers.length : 0;
                    const tasksBefore = beforeData ? beforeData.familyTasks.length : 0;
                    const membersAfter = afterData.familyMembers.length;
                    const tasksAfter = afterData.familyTasks.length;
                    
                    const isPersistent = (membersBefore === membersAfter && tasksBefore === tasksAfter);
                    
                    document.getElementById('refresh-status').textContent = 
                        `${isPersistent ? 'âœ… æ•°æ®æŒä¹…åŒ–æˆåŠŸ!' : 'âŒ æ•°æ®æŒä¹…åŒ–å¤±è´¥!'}\n\n` +
                        `åˆ·æ–°å‰: ${membersBefore}ä¸ªæˆå‘˜, ${tasksBefore}ä¸ªä»»åŠ¡\n` +
                        `åˆ·æ–°å: ${membersAfter}ä¸ªæˆå‘˜, ${tasksAfter}ä¸ªä»»åŠ¡\n\n` +
                        `æœ€åæ›´æ–°æ—¶é—´: ${afterData.lastUpdated}`;
                    
                    currentData = afterData;
                } else {
                    document.getElementById('refresh-status').textContent = 'âŒ åˆ·æ–°ååŠ è½½å¤±è´¥: ' + response.statusText;
                }
            } catch (error) {
                document.getElementById('refresh-status').textContent = 'âŒ åˆ·æ–°æµ‹è¯•é”™è¯¯: ' + error.message;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.onload = function() {
            loadServerData();
        };
    </script>
</body>
</html>